:plain
  $('.modal-backdrop').first().remove(); //remove backdrop from the loading box
  $(".form-modal").html("#{escape_javascript(render 'form', block: @block, farm: @farm, planting_projects: @planting_projects)}");
  $('#myModalAdd').modal('show');
  $('#myModalAdd').on('shown.bs.modal', function () {
    var stroke_color, fill_color;
    $('.loading').remove();
    $('#map-block').html(map.getDiv());

    function getLatlong(polygon){
      var polygonPoints = [];
      $.each(polygon.overlay.latLngs.j[0].j, function(key, latlng){
        polygonPoints.push("["+latlng.k+","+latlng.D+"]");
      });
      $("#block_shape_lat_long").val("["+polygonPoints.toString()+"]");
      $("#block_location_lat_long").val(getCenter(polygon.overlay).toString().slice(1,-1));
    }

    function polygonClick(polygon){
      google.maps.event.addListener(polygon.overlay,'click', function(event){
        infowindow.setContent('<div class ="btn btn-danger btn-xs btn-delete">Delete</div>&nbsp;<div class ="btn btn-warning btn-xs btn-edit">Edit</div>&nbsp;<div class ="btn btn-success btn-xs btn-done">Done</div>');
        if (event) {
          point = getCenter(this)
        }
        infowindow.setPosition(point);
        infowindow.open(map);
        google.maps.event.addListener(infowindow, 'domready', function(){ 
          $(".btn-delete").click(function(){
            polygon.overlay.setMap(null);
            infowindow.close();
          });
          $(".btn-edit").click(function(){
            infowindow.close();
            polygon.overlay.setEditable(true);
          });
          $(".btn-done").click(function(){
            infowindow.close();
            polygon.overlay.setEditable(false);
          });
        });
      });
    }

    function initDrawManager(color, mapObj){
      drawingManager = new google.maps.drawing.DrawingManager({
        drawingControl: false,
        polygonOptions: {
          fillColor: color,
          strokeColor: color,
          fillOpacity: 0.35,
          strokeWeight: 1.5,
          strokeOpacity: 0.8
        },
        map: mapObj
      });
      google.maps.event.addListener(drawingManager, 'overlaycomplete', function(polygon){
        drawingManager.setDrawingMode(null);
        polygonClick(polygon);
        getLatlong(polygon);
      });
    }
    
    $('#block_planting_project_id').change(function(){
      $('#btn-draw-block').show();
      switch ($(this).find('option:selected').text().toLowerCase()){
        case "coconut":
            initDrawManager('#5EFF4A', map);
            break;
        case "jackfruit":
            initDrawManager('#FFCC00', map);
            break;
        case "lemon":
            initDrawManager('#99FF33', map);
            break;
        case "mango":
            initDrawManager('#FFFF00', map);
            break;
        case "select planting type":
          $('#btn-draw-block').hide();
      }
    });
    
    $('#btn-draw-block').click(function(){
      drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
    });
    infowindow = new google.maps.InfoWindow();
    //Disable drawing mode when finishing polygon complete;
    /*google.maps.event.addListener(drawingManager, 'overlaycomplete', function(polygon){
      drawingManager.setDrawingMode(null);
      var polygonPoints = [];
      $.each(polygon.overlay.latLngs.j[0].j, function(key, latlng){
        polygonPoints.push("["+latlng.k+","+latlng.D+"]");
      });
      $("#block_shape_lat_long").val("["+polygonPoints.toString()+"]");
      $("#block_location_lat_long").val(getCenter(polygon.overlay).toString().slice(1,-1));
      google.maps.event.addListener(polygon.overlay,'click', function(event){
        infowindow.setContent('<div class ="btn btn-primary btn-xs btn-click">Click</div>');
        if (event) {
           point = getCenter(this)
        }
        infowindow.setPosition(point);
        infowindow.open(map);
      });
    });*/

    $('#myModalAdd').on('hidden.bs.modal', function () {
      drawingManager.setDrawingMode(null);
      $(".form-modal").empty();
      $('.reset-map').html(map.getDiv());
    });
  });